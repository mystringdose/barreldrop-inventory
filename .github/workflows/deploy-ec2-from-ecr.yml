name: Deploy ECR Images to EC2

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "ECR image tag to deploy (default: latest)"
        required: false
        default: "latest"
      deploy_branch:
        description: "Git branch to sync on EC2 before deploy"
        required: false
        default: "main"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  EC2_INSTANCE_TAG_NAME: ${{ vars.EC2_INSTANCE_TAG_NAME || 'barreldrop-app' }}
  ECR_FRONTEND_REPOSITORY: ${{ vars.ECR_FRONTEND_REPOSITORY }}
  ECR_API_REPOSITORY: ${{ vars.ECR_API_REPOSITORY }}
  ECR_MONGO_REPOSITORY: ${{ vars.ECR_MONGO_REPOSITORY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve deploy metadata
        id: meta
        run: |
          set -euo pipefail
          account_id="$(aws sts get-caller-identity --query Account --output text)"
          instance_id="$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${EC2_INSTANCE_TAG_NAME}" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].InstanceId' --output text | awk 'NR==1{print $1}')"

          if [ -z "${instance_id}" ] || [ "${instance_id}" = "None" ]; then
            echo "No running EC2 instance found for tag Name=${EC2_INSTANCE_TAG_NAME}" >&2
            exit 1
          fi

          echo "account_id=${account_id}" >> "$GITHUB_OUTPUT"
          echo "instance_id=${instance_id}" >> "$GITHUB_OUTPUT"
          echo "registry=${account_id}.dkr.ecr.${AWS_REGION}.amazonaws.com" >> "$GITHUB_OUTPUT"

      - name: Send deploy command via SSM
        id: ssm
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          DEPLOY_BRANCH: ${{ inputs.deploy_branch }}
        run: |
          set -euo pipefail

          command_id="$(aws ssm send-command \
            --instance-ids "${{ steps.meta.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy ${IMAGE_TAG} to BarrelDrop" \
            --parameters "commands=[\"set -euo pipefail\",\"export HOME=/root\",\"git config --system --add safe.directory /opt/barreldrop/repo\",\"cd /opt/barreldrop/repo\",\"git fetch origin '${DEPLOY_BRANCH}'\",\"git checkout -B '${DEPLOY_BRANCH}' 'origin/${DEPLOY_BRANCH}'\",\"AWS_REGION='${AWS_REGION}' ECR_REGISTRY='${{ steps.meta.outputs.registry }}' ECR_FRONTEND_REPOSITORY='${ECR_FRONTEND_REPOSITORY}' ECR_API_REPOSITORY='${ECR_API_REPOSITORY}' ECR_MONGO_REPOSITORY='${ECR_MONGO_REPOSITORY}' ./deploy/deploy_from_ecr.sh '${IMAGE_TAG}'\"]" \
            --query 'Command.CommandId' \
            --output text)"

          echo "command_id=${command_id}" >> "$GITHUB_OUTPUT"

      - name: Wait for deploy completion
        id: wait
        continue-on-error: true
        run: |
          set -euo pipefail
          aws ssm wait command-executed \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${{ steps.meta.outputs.instance_id }}"

      - name: Print deploy output
        if: always()
        id: invocation
        run: |
          set -euo pipefail
          aws ssm get-command-invocation \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${{ steps.meta.outputs.instance_id }}" \
            --query '{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent}' \
            --output json | tee /tmp/ssm-invocation.json

      - name: Fail workflow when deploy command failed
        if: always()
        run: |
          set -euo pipefail
          status="$(aws ssm get-command-invocation \
            --command-id "${{ steps.ssm.outputs.command_id }}" \
            --instance-id "${{ steps.meta.outputs.instance_id }}" \
            --query 'Status' \
            --output text)"
          if [ "$status" != "Success" ]; then
            echo "SSM deploy command failed with status: $status" >&2
            exit 1
          fi
